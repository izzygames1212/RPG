const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const keys = {};

document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

class Fighter {
  constructor(x, color, controls) {
    this.x = x;
    this.y = 460;
    this.w = 50;
    this.h = 80;
    this.color = color;
    this.health = 100;
    this.vy = 0;
    this.jump = false;
    this.controls = controls;
    this.attackCooldown = 0;
  }

  update(opponent) {
    // Movement
    if (keys[this.controls.left]) this.x -= 4;
    if (keys[this.controls.right]) this.x += 4;

    // Jump
    if (!this.jump && keys[this.controls.jump]) {
      this.vy = -15;
      this.jump = true;
    }

    this.vy += 1; // gravity
    this.y += this.vy;
    if (this.y > 460) {
      this.y = 460;
      this.vy = 0;
      this.jump = false;
    }

    // Attack
    if (this.attackCooldown <= 0 && keys[this.controls.attack]) {
      const range = {
        x: this.x - 30,
        y: this.y,
        w: this.w + 60,
        h: this.h
      };

      if (this.rectsOverlap(range, opponent)) {
        opponent.health -= 10;
        sparks.push(new Spark(opponent.x + 25, opponent.y));
      }

      this.attackCooldown = 30;
    }

    this.attackCooldown--;
  }

  rectsOverlap(r, other) {
    return (
      r.x < other.x + other.w &&
      r.x + r.w > other.x &&
      r.y < other.y + other.h &&
      r.y + r.h > other.y
    );
  }

  draw() {
    ctx.fillStyle = this.color;
    ctx.fillRect(this.x, this.y, this.w, this.h);
  }
}

class Spark {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.life = 15;
  }

  draw() {
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
    ctx.fill();
    this.life--;
  }
}

const p1 = new Fighter(100, "red", {
  left: "KeyA",
  right: "KeyD",
  jump: "KeyW",
  attack: "KeyF"
});

const p2 = new Fighter(800, "blue", {
  left: "ArrowLeft",
  right: "ArrowRight",
  jump: "ArrowUp",
  attack: "Numpad1"
});

const sparks = [];

function drawHealthBars() {
  ctx.fillStyle = "red";
  ctx.fillRect(50, 20, p1.health * 2, 15);
  ctx.fillStyle = "blue";
  ctx.fillRect(710, 20, p2.health * 2, 15);
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  p1.update(p2);
  p2.update(p1);

  p1.draw();
  p2.draw();

  drawHealthBars();

  // Draw sparks
  for (let i = sparks.length - 1; i >= 0; i--) {
    sparks[i].draw();
    if (sparks[i].life <= 0) sparks.splice(i, 1);
  }

  requestAnimationFrame(gameLoop);
}

gameLoop();

    
 
